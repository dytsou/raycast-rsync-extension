name: Publish to GitHub Packages

on:
  push:
    branches:
      - main
    paths:
      - "package.json"
      - "package-lock.json"
      - "src/**"
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type (patch, minor, major)"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build extension
        run: npm run build

      - name: Get package info
        id: package-info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          NAME=$(node -p "require('./package.json').name")

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "Package: $NAME@$VERSION"

      - name: Check if version exists
        id: check-version
        run: |
          VERSION=${{ steps.package-info.outputs.version }}
          PACKAGE_NAME="${{ steps.package-info.outputs.name }}"

          # Set up GitHub Packages registry
          npm config set registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken ${{ secrets.GITHUB_TOKEN }}

          if npm view "$PACKAGE_NAME@$VERSION" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version $VERSION already exists, skipping publish"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version $VERSION is new, will publish"
          fi
        continue-on-error: true

      - name: Publish to GitHub Packages
        if: steps.check-version.outputs.exists == 'false'
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.name }}"
          VERSION=${{ steps.package-info.outputs.version }}

          echo "Publishing $PACKAGE_NAME@$VERSION to GitHub Packages..."

          # Configure npm to use GitHub Packages registry
          npm config set registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken ${{ secrets.GITHUB_TOKEN }}

          # Publish to GitHub Packages (unscoped package goes to repo owner's namespace)
          npm publish

          echo "Successfully published $PACKAGE_NAME@$VERSION to GitHub Packages"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Git tag
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION=${{ steps.package-info.outputs.version }}
          PACKAGE_NAME="${{ steps.package-info.outputs.name }}"

          TAG_NAME="v$VERSION"

          # Check if tag already exists
          if git tag -l | grep -q "^$TAG_NAME$"; then
            echo "Tag $TAG_NAME already exists, skipping tag creation"
          else
            echo "Creating tag $TAG_NAME"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
            echo "Tag $TAG_NAME created and pushed"
          fi

      - name: Create GitHub Release
        if: steps.check-version.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.package-info.outputs.version }}
          name: Release v${{ steps.package-info.outputs.version }}
          body: |
            ## ${{ steps.package-info.outputs.name }}@v${{ steps.package-info.outputs.version }}

            **Published to GitHub Packages**

            ### Installation

            ```bash
            npm install ${{ github.repository_owner }}/${{ steps.package-info.outputs.name }} --registry=https://npm.pkg.github.com
            ```

            Or add to your `.npmrc`:

            ```
            ${{ github.repository_owner }}:registry=https://npm.pkg.github.com
            //npm.pkg.github.com/:_authToken=YOUR_GITHUB_TOKEN
            ```

            Then install:

            ```bash
            npm install ${{ github.repository_owner }}/${{ steps.package-info.outputs.name }}
            ```

            ### What's New

            - Automated release from CI/CD pipeline
            - All tests passed ‚úÖ
            - Extension built successfully ‚úÖ

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Summary
        if: always()
        run: |
          echo "## üì¶ Publish Summary"
          echo "Package: ${{ steps.package-info.outputs.name }}@${{ steps.package-info.outputs.version }}"

          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "‚úÖ Version already exists - skipped publishing"
          elif [ "${{ steps.check-version.outputs.exists }}" == "false" ]; then
            echo "‚úÖ Successfully published to GitHub Packages"
            echo "üè∑Ô∏è  Created tag: v${{ steps.package-info.outputs.version }}"
            echo "üìù Created release: v${{ steps.package-info.outputs.version }}"
          else
            echo "‚ùå Publish status unknown"
          fi

          echo ""
          echo "### üîó Links"
          echo "- **GitHub Packages**: https://github.com/${{ github.repository }}/packages"
          echo "- **Install Command**: npm install ${{ github.repository_owner }}/${{ steps.package-info.outputs.name }} --registry=https://npm.pkg.github.com"
          echo "- **Release**: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.package-info.outputs.version }}"
